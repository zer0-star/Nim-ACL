---
data:
  _extendedDependsOn:
  - icon: ':heavy_check_mark:'
    path: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
    title: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - icon: ':heavy_check_mark:'
    path: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
    title: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - icon: ':heavy_check_mark:'
    path: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
    title: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - icon: ':heavy_check_mark:'
    path: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
    title: atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  _extendedRequiredBy:
  - icon: ':warning:'
    path: atcoder/extra/header/chaemon_header.nim
    title: atcoder/extra/header/chaemon_header.nim
  - icon: ':warning:'
    path: atcoder/extra/header/chaemon_header.nim
    title: atcoder/extra/header/chaemon_header.nim
  - icon: ':warning:'
    path: atcoder/extra/header/chaemon_header.nim
    title: atcoder/extra/header/chaemon_header.nim
  - icon: ':warning:'
    path: atcoder/extra/header/chaemon_header.nim
    title: atcoder/extra/header/chaemon_header.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template.nim
    title: atcoder/extra/template/atcoder-tools_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template.nim
    title: atcoder/extra/template/atcoder-tools_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template.nim
    title: atcoder/extra/template/atcoder-tools_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template.nim
    title: atcoder/extra/template/atcoder-tools_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_global.nim
    title: atcoder/extra/template/atcoder-tools_template_global.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_global.nim
    title: atcoder/extra/template/atcoder-tools_template_global.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_global.nim
    title: atcoder/extra/template/atcoder-tools_template_global.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_global.nim
    title: atcoder/extra/template/atcoder-tools_template_global.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_with_solve.nim
    title: atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_with_solve.nim
    title: atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_with_solve.nim
    title: atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - icon: ':warning:'
    path: atcoder/extra/template/atcoder-tools_template_with_solve.nim
    title: atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - icon: ':warning:'
    path: atcoder/extra/template/template.nim
    title: atcoder/extra/template/template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/template.nim
    title: atcoder/extra/template/template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/template.nim
    title: atcoder/extra/template/template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/template.nim
    title: atcoder/extra/template/template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/vim_template.nim
    title: atcoder/extra/template/vim_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/vim_template.nim
    title: atcoder/extra/template/vim_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/vim_template.nim
    title: atcoder/extra/template/vim_template.nim
  - icon: ':warning:'
    path: atcoder/extra/template/vim_template.nim
    title: atcoder/extra/template/vim_template.nim
  _extendedVerifiedWith:
  - icon: ':heavy_check_mark:'
    path: verify/extra/graph/yosupo_cycle_detection_test.nim
    title: verify/extra/graph/yosupo_cycle_detection_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/graph/yosupo_cycle_detection_test.nim
    title: verify/extra/graph/yosupo_cycle_detection_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
    title: verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
    title: verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
    title: verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
    title: verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
  _isVerificationFailed: false
  _pathExtension: nim
  _verificationStatusIcon: ':heavy_check_mark:'
  attributes:
    links:
    - https://github.com/nim-lang/Nim/pull/8531#issuecomment-410436458
  bundledCode: "Traceback (most recent call last):\n  File \"/opt/hostedtoolcache/Python/3.10.6/x64/lib/python3.10/site-packages/onlinejudge_verify/documentation/build.py\"\
    , line 71, in _render_source_code_stat\n    bundled_code = language.bundle(stat.path,\
    \ basedir=basedir, options={'include_paths': [basedir]}).decode()\n  File \"/opt/hostedtoolcache/Python/3.10.6/x64/lib/python3.10/site-packages/onlinejudge_verify/languages/nim.py\"\
    , line 86, in bundle\n    raise NotImplementedError\nNotImplementedError\n"
  code: "when not declared ATCODER_INTERNAL_SUGAR_HPP:\n  const ATCODER_INTERNAL_SUGAR_HPP*\
    \ = 1\n  import std/macros, std/typetraits\n  \n  proc checkPragma(ex, prag: var\
    \ NimNode) =\n  #  since (1, 3):\n    block:\n      if ex.kind == nnkPragmaExpr:\n\
    \        prag = ex[1]\n        if ex[0].kind == nnkPar and ex[0].len == 1:\n \
    \         ex = ex[0][0]\n        else:\n          ex = ex[0]\n  \n  proc createProcType(p,\
    \ b: NimNode): NimNode {.compileTime.} =\n    result = newNimNode(nnkProcTy)\n\
    \    var\n      formalParams = newNimNode(nnkFormalParams).add(b)\n      p = p\n\
    \      prag = newEmptyNode()\n  \n    checkPragma(p, prag)\n  \n    case p.kind\n\
    \    of nnkPar, nnkTupleConstr:\n      for i in 0 ..< p.len:\n        let ident\
    \ = p[i]\n        var identDefs = newNimNode(nnkIdentDefs)\n        case ident.kind\n\
    \        of nnkExprColonExpr:\n          identDefs.add ident[0]\n          identDefs.add\
    \ ident[1]\n        else:\n          identDefs.add newIdentNode(\"i\" & $i)\n\
    \          identDefs.add(ident)\n        identDefs.add newEmptyNode()\n      \
    \  formalParams.add identDefs\n    else:\n      var identDefs = newNimNode(nnkIdentDefs)\n\
    \      identDefs.add newIdentNode(\"i0\")\n      identDefs.add(p)\n      identDefs.add\
    \ newEmptyNode()\n      formalParams.add identDefs\n  \n    result.add formalParams\n\
    \    result.add prag\n  \n  macro `=>`*(p, b: untyped): untyped =\n    ## Syntax\
    \ sugar for anonymous procedures.\n    ## It also supports pragmas.\n    var\n\
    \      params = @[ident\"auto\"]\n      name = newEmptyNode()\n      kind = nnkLambda\n\
    \      pragma = newEmptyNode()\n      p = p\n  \n    checkPragma(p, pragma)\n\
    \  \n    if p.kind == nnkInfix and p[0].kind == nnkIdent and p[0].eqIdent\"->\"\
    :\n      params[0] = p[2]\n      p = p[1]\n  \n    checkPragma(p, pragma) # check\
    \ again after -> transform\n#    since (1, 3):\n    block:\n#      if p.kind ==\
    \ nnkCall:\n      if p.kind in {nnkCall, nnkObjConstr}:\n        # foo(x, y) =>\
    \ x + y\n        kind = nnkProcDef\n        name = p[0]\n        let newP = newNimNode(nnkPar)\n\
    \        for i in 1..<p.len:\n          newP.add(p[i])\n        p = newP\n  \n\
    \    case p.kind\n    of nnkPar, nnkTupleConstr:\n      var untypedBeforeColon\
    \ = 0\n      for i, c in p:\n        var identDefs = newNimNode(nnkIdentDefs)\n\
    \        case c.kind\n        of nnkExprColonExpr:\n          let t = c[1]\n \
    \ #        since (1, 3):\n          block:\n            # + 1 here because of\
    \ return type in params\n            for j in (i - untypedBeforeColon + 1) ..\
    \ i:\n              params[j][1] = t\n          untypedBeforeColon = 0\n     \
    \     identDefs.add(c[0])\n          identDefs.add(t)\n          identDefs.add(newEmptyNode())\n\
    \        of nnkIdent:\n          identDefs.add(c)\n          identDefs.add(newIdentNode(\"\
    auto\"))\n          identDefs.add(newEmptyNode())\n          inc untypedBeforeColon\n\
    \        of nnkInfix:\n          if c[0].kind == nnkIdent and c[0].eqIdent\"->\"\
    :\n            var procTy = createProcType(c[1], c[2])\n            params[0]\
    \ = procTy[0][0]\n            for i in 1 ..< procTy[0].len:\n              params.add(procTy[0][i])\n\
    \          else:\n            error(\"Expected proc type (->) got (\" & c[0].strVal\
    \ & \").\", c)\n          break\n        else:\n          error(\"Incorrect procedure\
    \ parameter list.\", c)\n        params.add(identDefs)\n    of nnkIdent:\n   \
    \   var identDefs = newNimNode(nnkIdentDefs)\n      identDefs.add(p)\n      identDefs.add(ident\"\
    auto\")\n      identDefs.add(newEmptyNode())\n      params.add(identDefs)\n  \
    \  else:\n      error(\"Incorrect procedure parameter list.\", p)\n    result\
    \ = newProc(body = b, params = params,\n                     pragmas = pragma,\
    \ name = name,\n                     procType = kind)\n\n  macro `->`*(p, b: untyped):\
    \ untyped =\n    result = createProcType(p, b)\n  \n  macro dump*(x: untyped):\
    \ untyped =\n    let s = x.toStrLit\n    let r = quote do:\n      debugEcho `s`,\
    \ \" = \", `x`\n    return r\n  \n  # TODO: consider exporting this in macros.nim\n\
    \  proc freshIdentNodes(ast: NimNode): NimNode =\n    # Replace NimIdent and NimSym\
    \ by a fresh ident node\n    # see also https://github.com/nim-lang/Nim/pull/8531#issuecomment-410436458\n\
    \    proc inspect(node: NimNode): NimNode =\n      case node.kind:\n      of nnkIdent,\
    \ nnkSym:\n        result = ident($node)\n      of nnkEmpty, nnkLiterals:\n  \
    \      result = node\n      else:\n        result = node.kind.newTree()\n    \
    \    for child in node:\n          result.add inspect(child)\n    result = inspect(ast)\n\
    \  \n  macro capture*(locals: varargs[typed], body: untyped): untyped =\n    var\
    \ params = @[newIdentNode(\"auto\")]\n    let locals = if locals.len == 1 and\
    \ locals[0].kind == nnkBracket: locals[0]\n                 else: locals\n   \
    \ for arg in locals:\n      if arg.strVal == \"result\":\n        error(\"The\
    \ variable name cannot be `result`!\", arg)\n      params.add(newIdentDefs(ident(arg.strVal),\
    \ freshIdentNodes getTypeInst arg))\n    result = newNimNode(nnkCall)\n    result.add(newProc(newEmptyNode(),\
    \ params, body, nnkProcDef))\n    for arg in locals: result.add(arg)\n  \n  import\
    \ atcoder/extra/forward_compatibility/internal_underscored_calls\n\n  macro dup*[T](arg:\
    \ T, calls: varargs[untyped]): T =\n    result = newNimNode(nnkStmtListExpr, arg)\n\
    \    let tmp = genSym(nskVar, \"dupResult\")\n    result.add newVarStmt(tmp, arg)\n\
    \    underscoredCalls(result, calls, tmp)\n    result.add tmp\n\n  proc transLastStmt(n,\
    \ res, bracketExpr: NimNode): (NimNode, NimNode, NimNode) =\n    # Looks for the\
    \ last statement of the last statement, etc...\n    case n.kind\n    of nnkIfExpr,\
    \ nnkIfStmt, nnkTryStmt, nnkCaseStmt:\n      result[0] = copyNimTree(n)\n    \
    \  result[1] = copyNimTree(n)\n      result[2] = copyNimTree(n)\n      for i in\
    \ ord(n.kind == nnkCaseStmt)..<n.len:\n        (result[0][i], result[1][^1], result[2][^1])\
    \ = transLastStmt(n[i], res, bracketExpr)\n    of nnkStmtList, nnkStmtListExpr,\
    \ nnkBlockStmt, nnkBlockExpr, nnkWhileStmt,\n        nnkForStmt, nnkElifBranch,\
    \ nnkElse, nnkElifExpr, nnkOfBranch, nnkExceptBranch:\n      result[0] = copyNimTree(n)\n\
    \      result[1] = copyNimTree(n)\n      result[2] = copyNimTree(n)\n      if\
    \ n.len >= 1:\n        (result[0][^1], result[1][^1], result[2][^1]) = transLastStmt(n[^1],\
    \ res, bracketExpr)\n    of nnkTableConstr:\n      result[1] = n[0][0]\n     \
    \ result[2] = n[0][1]\n      if bracketExpr.len == 1:\n        bracketExpr.add([newCall(bindSym\"\
    typeof\", newEmptyNode()), newCall(\n            bindSym\"typeof\", newEmptyNode())])\n\
    \      template adder(res, k, v) = res[k] = v\n      result[0] = getAst(adder(res,\
    \ n[0][0], n[0][1]))\n    of nnkCurly:\n      result[2] = n[0]\n      if bracketExpr.len\
    \ == 1:\n        bracketExpr.add(newCall(bindSym\"typeof\", newEmptyNode()))\n\
    \      template adder(res, v) = res.incl(v)\n      result[0] = getAst(adder(res,\
    \ n[0]))\n    else:\n      result[2] = n\n      if bracketExpr.len == 1:\n   \
    \     bracketExpr.add(newCall(bindSym\"typeof\", newEmptyNode()))\n      template\
    \ adder(res, v) = res.add(v)\n      result[0] = getAst(adder(res, n))\n  \n  macro\
    \ collect*(init, body: untyped): untyped =\n    # analyse the body, find the deepest\
    \ expression 'it' and replace it via\n    # 'result.add it'\n    let res = genSym(nskVar,\
    \ \"collectResult\")\n    expectKind init, {nnkCall, nnkIdent, nnkSym}\n    let\
    \ bracketExpr = newTree(nnkBracketExpr,\n      if init.kind == nnkCall: init[0]\
    \ else: init)\n    let (resBody, keyType, valueType) = transLastStmt(body, res,\
    \ bracketExpr)\n    if bracketExpr.len == 3:\n      bracketExpr[1][1] = keyType\n\
    \      bracketExpr[2][1] = valueType\n    else:\n      bracketExpr[1][1] = valueType\n\
    \    let call = newTree(nnkCall, bracketExpr)\n    if init.kind == nnkCall:\n\
    \      for i in 1 ..< init.len:\n        call.add init[i]\n    result = newTree(nnkStmtListExpr,\
    \ newVarStmt(res, call), resBody, res)\n"
  dependsOn:
  - atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  - atcoder/extra/forward_compatibility/internal_underscored_calls.nim
  isVerificationFile: false
  path: atcoder/extra/forward_compatibility/internal_sugar.nim
  requiredBy:
  - atcoder/extra/template/vim_template.nim
  - atcoder/extra/template/vim_template.nim
  - atcoder/extra/template/atcoder-tools_template_global.nim
  - atcoder/extra/template/atcoder-tools_template_global.nim
  - atcoder/extra/template/atcoder-tools_template.nim
  - atcoder/extra/template/atcoder-tools_template.nim
  - atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - atcoder/extra/template/template.nim
  - atcoder/extra/template/template.nim
  - atcoder/extra/header/chaemon_header.nim
  - atcoder/extra/header/chaemon_header.nim
  - atcoder/extra/template/vim_template.nim
  - atcoder/extra/template/vim_template.nim
  - atcoder/extra/template/atcoder-tools_template_global.nim
  - atcoder/extra/template/atcoder-tools_template_global.nim
  - atcoder/extra/template/atcoder-tools_template.nim
  - atcoder/extra/template/atcoder-tools_template.nim
  - atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - atcoder/extra/template/atcoder-tools_template_with_solve.nim
  - atcoder/extra/template/template.nim
  - atcoder/extra/template/template.nim
  - atcoder/extra/header/chaemon_header.nim
  - atcoder/extra/header/chaemon_header.nim
  timestamp: '2022-07-09 03:01:13+09:00'
  verificationStatus: LIBRARY_ALL_AC
  verifiedWith:
  - verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
  - verify/extra/structure/yosupo_queue_operate_all_composite_test.nim
  - verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
  - verify/extra/structure/yosupo_point_set_range_composite_reversible_splay_tree_test.nim
  - verify/extra/graph/yosupo_cycle_detection_test.nim
  - verify/extra/graph/yosupo_cycle_detection_test.nim
documentation_of: atcoder/extra/forward_compatibility/internal_sugar.nim
layout: document
redirect_from:
- /library/atcoder/extra/forward_compatibility/internal_sugar.nim
- /library/atcoder/extra/forward_compatibility/internal_sugar.nim.html
title: atcoder/extra/forward_compatibility/internal_sugar.nim
---
